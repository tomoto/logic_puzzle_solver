#include "sli/solver/Solver.h"
#include "sli/serializer/Loader.h"
#include "sli/serializer/Formatter.h"
#include "utl/StrUtils.h"

#include <gtest/gtest.h>
#include <sstream>

using namespace sli;
using namespace utl::StrUtils;

static void testFast(vector<string> lines) {
  auto b = Loader::loadFull(lines);
  b.clearState();
  Solver solver;
  auto state = solver.solve(b);
  EXPECT_EQ(state.status, cmn::CompletionStatus::complete);
  auto s = Formatter::formatFull(state.board);
  auto s2 = s;
  std::replace(s.begin(), s.end(), 'x', ' ');
  EXPECT_EQ(s, join(lines, "\n") + "\n") << s2;
}

TEST(sli_Solver, SL_0001) {
  // 2009年頃の二コリの問題 by Casty氏
  testFast({
    "+-+-+ + + + +-+ + + +",
    "|   |    0 2| |      ",
    "+ +-+ + + +-+ +-+ +-+",
    "|2|3 0    |    2|2|3|",
    "+ +-+ +-+ + +-+ + + +",
    "|   | |3| | |3| | | |",
    "+-+ +-+ +-+ + + +-+ +",
    " 3|      2 2| |    1|",
    "+-+ +-+-+-+-+ +-+-+ +",
    "|  2|  2     0   2| |",
    "+-+-+ +-+ +-+ +-+ + +",
    "   2  |3| | |3| |3| |",
    "+-+-+-+ +-+ +-+ +-+ +",
    "|3       1 0       2|",
    "+-+ +-+-+ + +-+-+-+-+",
    "  | |  2|   |3       ",
    "+-+ +-+ +-+ +-+ +-+ +",
    "|3 0 3|   |   |3|3|1 ",
    "+-+ +-+ + +-+ +-+ + +",
    "  | |    0 2|     |  ",
    "+ +-+ + + + +-+-+-+ +",
    });
}

TEST(sli_Solver, SL_0007) {
  // 2009年頃の二コリの問題 by ももてれう氏
  testFast({
    "+ + + + + + +-+-+-+-+-+-+-+ +-+-+ + + +-+-+-+-+-+",
    " 1   0   0  |  2   2      |3|   |  0  |  1 1 1 2|",
    "+-+ + +-+ + +-+-+ +-+-+-+ +-+ + +-+ +-+ + + + + +",
    "| |   | |      2| |2   3|      1  | |    1 1 1 1|",
    "+ + +-+ + +-+ + +-+ + +-+ +-+ +-+ +-+ +-+-+-+-+ +",
    "| |2|3 1|3|3|  1   0  |   |3| | |  1  |       | |",
    "+ + +-+ +-+ +-+-+ + +-+ +-+ +-+ +-+ +-+ +-+ +-+ +",
    "| |   |        3|  2|  2|      0  | |2  |3| |  1|",
    "+ +-+-+ +-+ + +-+ +-+ +-+ +-+ + + +-+ + + +-+ + +",
    "|  1 1 1|3|1  |3  |2  |   | |        0  |1      |",
    "+-+ + + + + + +-+ + + + + + +-+ + +-+ +-+ + +-+ +",
    "  |     | |  0  | |   |  1|1 3|1 2| |3|  0  | |3|",
    "+ +-+ +-+ + + +-+ +-+ +-+ + +-+ +-+ +-+ + +-+ +-+",
    " 0  | |3  |1  |2 0 2|2 3| | |   |    1   2|      ",
    "+ +-+ +-+ + + + + + +-+-+ + +-+-+ +-+ + +-+ + + +",
    "  |    3| |1  |          1|1 1 1 2| |2  |3     0 ",
    "+-+ +-+-+ + +-+ + + + + + + + + +-+ +-+ +-+-+-+ +",
    "|3  |  1  |2|  0 1 1 1 1  |     |  0  |       |  ",
    "+-+ +-+ + + + + +-+-+-+-+-+ +-+-+ + + +-+-+-+ +-+",
    "  |   |2  |3|   |           |2   1   1 1 1 2|2  |",
    "+ +-+ +-+ +-+ +-+ + +-+ + + + + +-+-+-+ + + +-+ +",
    " 0  |  2|  2  |  0  | |  0  |1  |2    |       | |",
    "+ + +-+ +-+-+ + + +-+ +-+ +-+ + + +-+ +-+ +-+ + +",
    "      |     |3|   |  0  | |  0  |3| |2 2|3|3|3| |",
    "+-+-+ +-+-+ +-+ + +-+ +-+ +-+ + +-+ +-+ +-+ +-+ +",
    "|2 2|2 2  |      0  | |  0  |1   1    |         |",
    "+ + +-+-+-+ +-+ + +-+ +-+ +-+ + + +-+-+ +-+-+-+-+",
    "|2 1 2 2    |3|   |  0  | |  0   1|    2|  1   1 ",
    "+-+-+-+-+-+-+ +-+-+ + + +-+ + + + +-+-+-+ + + + +",
    });
}

TEST(sli_Solver, SL_0008) {
  // 2009年頃の二コリの問題 by 339氏
  testFast({
    "+-+-+-+-+ +-+-+ + +-+-+-+-+-+-+-+-+ + + + + +-+-+",
    "|  1 1  | |2  |  1|    1 1     1  |  0     1|2  |",
    "+-+ + + +-+ +-+ + +-+-+ + +-+-+ +-+ + +-+-+ + + +",
    " 3|    0    |3 0   1 3|   |2 2| |2 1  |  3| |  1|",
    "+-+ + + +-+ +-+ + + +-+ + + + + + +-+-+ +-+ + + +",
    "|3     1| |   |     |     |   | | |     |3  |  1|",
    "+-+-+-+ + + +-+ +-+ +-+ +-+ +-+ +-+ +-+ +-+ +-+ +",
    "   1 3| | |3|   |3|   |3|2  |  0    |3|   |2 2| |",
    "+ + +-+ + +-+ +-+ +-+ +-+ +-+ + +-+-+ + + +-+ + +",
    "    |   |     |3    |2    |3    |2    |     | | |",
    "+-+-+ + +-+ + +-+-+ +-+-+ +-+ +-+ +-+-+ +-+ +-+ +",
    "|2       3|       |2    |   |3|   |    2| |    1|",
    "+ +-+ +-+-+ + + + +-+ +-+ + +-+ + +-+ +-+ +-+ + +",
    "| |3| |2     1 1    | |3 1       0 2| |  0  |2  |",
    "+ + +-+ + +-+-+-+-+-+ +-+-+ + +-+ + + +-+ + +-+-+",
    "| |1   0  |  1 1       1 3|   | |2 1|   |1   1   ",
    "+ + + + +-+ + + +-+ +-+ +-+ + + +-+ +-+ + + + + +",
    "|2|     |3      | |3| | |    1|   |   |2|      0 ",
    "+ +-+ + +-+ + +-+ +-+ + + +-+ + + +-+ + +-+ + + +",
    "|   |     |   |3     2| | |3| |  0  | |   |      ",
    "+ + + +-+-+ + +-+-+ +-+ +-+ + +-+ +-+ +-+ +-+ + +",
    "|  1|3|    0     3| |  0 2  |  3| |  0  |  3|1   ",
    "+ + +-+ + + + + +-+ + + +-+ +-+-+ +-+ + + +-+ +-+",
    "|1     0        |   |   | |         |   |2|   |3|",
    "+ + + + +-+-+ +-+ + +-+ + +-+-+-+ + +-+-+ +-+-+ +",
    "|1     1|   |2|3   0 3| |  1 1  |2 0     0     1|",
    "+ +-+-+ + +-+ +-+-+ +-+ + + + + +-+ +-+ + +-+-+ +",
    "| |2 2| | |3     3| |  2|1     0  | |3|   |2 2| |",
    "+-+ + +-+ +-+-+-+-+ +-+-+ + + + + +-+ +-+-+ + +-+",
    });
}

TEST(sli_Solver, smallLoop33) {
  // 3が向かい合う小ループ問題は特殊パス
  testFast({
    "+-+ + +",
    "|3|    ",
    "+ + + +",
    "|3|    ",
    "+-+ + +",
    "     0 ",
    "+ + + +",
    });
}

// TEST(sli_Solver, smallLoop1x1) {
//   // 1マスの小ループ問題も解けない
//   testFast({
//     "+-+",
//     "| |",
//     "+-+",
//     });
// }

TEST(sli_Solver, empty) {
  // 空
  testFast({
    "+-+-+",
    "|   |",
    "+-+ +",
    "  | |",
    "+ +-+",
    });
}
